name: Deploy to EC2

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      SPRING_PROFILES_ACTIVE: prod
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_PORT: ${{ secrets.DB_PORT }}
      DB_NAME: ${{ secrets.DB_NAME }}
      DB_USERNAME: ${{ secrets.DB_USERNAME }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      S3_BUCKET: ${{ secrets.S3_BUCKET }}
      S3_BASE_URL: ${{ secrets.S3_BASE_URL }}
      S3_REGION: ${{ secrets.S3_REGION }}

    steps:
      # 1️⃣ 리포지토리 코드 체크아웃
      - name: Checkout source code
        uses: actions/checkout@v3

      # 2️⃣ JDK 17 세팅
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3️⃣ Gradle 빌드 (테스트 제외)
      - name: Build with Gradle
        run: |
          chmod +x gradlew
          ./gradlew clean bootJar -x test

      # 4️⃣ 빌드 결과 확인용 (디버깅 시 유용)
      - name: Verify build output
        run: ls -lh build/libs

      # 5️⃣ EC2로 jar와 Dockerfile 전송
      - name: Copy JAR and Dockerfile to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.AWS_EC2_HOST }}
          username: ${{ secrets.AWS_EC2_USER }}
          key: ${{ secrets.AWS_SSH_KEY }}
          source: "build/libs/*.jar,Dockerfile"
          target: "/home/ubuntu/app"

      # 6️⃣ EC2에서 Docker 빌드 및 컨테이너 실행
      - name: Deploy on EC2 via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_EC2_HOST }}
          username: ${{ secrets.AWS_EC2_USER }}
          key: ${{ secrets.AWS_SSH_KEY }}
          script: |
            cd /home/ubuntu/app
            echo "✅ 현재 디렉토리 확인:" && pwd
            echo "✅ 파일 목록:" && ls -lh

            docker stop myapp || true
            docker rm myapp || true
            docker rmi myapp:latest || true

            echo "✅ Docker 빌드 시작..."
            docker build -t myapp .

            echo "✅ 컨테이너 실행..."
            docker run -d -p 8080:8080 --name myapp --restart always myapp

            echo "✅ 실행 중인 컨테이너 확인:"
            docker ps -a
