name: Deploy to EC2

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      SPRING_PROFILES_ACTIVE: prod

    steps:
      # 1ï¸âƒ£ ë¦¬í¬ì§€í† ë¦¬ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout source code
        uses: actions/checkout@v3

      # 2ï¸âƒ£ JDK 17 ì„¸íŒ…
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3ï¸âƒ£ Gradle ë¹Œë“œ (í…ŒìŠ¤íŠ¸ ì œì™¸)
      - name: Build with Gradle
        run: |
          chmod +x gradlew
          ./gradlew clean bootJar -x test

      # 4ï¸âƒ£ ë¹Œë“œ ê²°ê³¼ í™•ì¸ìš© (ë””ë²„ê¹… ì‹œ ìœ ìš©)
      - name: Verify build output
        run: ls -lh build/libs

      # 5ï¸âƒ£ EC2ë¡œ jarì™€ Dockerfile ì „ì†¡
      - name: Copy JAR and Dockerfile to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.AWS_EC2_HOST }}
          username: ${{ secrets.AWS_EC2_USER }}
          key: ${{ secrets.AWS_SSH_KEY }}
          source: "build/libs/*.jar,Dockerfile"
          target: "/home/ubuntu/app"

      # 6ï¸âƒ£ EC2ì—ì„œ Docker ë¹Œë“œ ë° ì»¨í…Œì´ë„ˆ ì‹¤í–‰
      - name: Deploy on EC2 via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_EC2_HOST }}
          username: ${{ secrets.AWS_EC2_USER }}
          key: ${{ secrets.AWS_SSH_KEY }}
          script: |
            cd /home/ubuntu/app
            echo "âœ… í˜„ì¬ ë””ë ‰í† ë¦¬ í™•ì¸:" && pwd
            echo "âœ… íŒŒì¼ ëª©ë¡:" && ls -lh

            echo "ğŸ§¹ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬..."
            docker stop myapp || true
            docker rm myapp || true
            docker rmi myapp:latest || true

            echo "ğŸ³ Docker ë¹Œë“œ ì‹œì‘..."
            docker build -t myapp .

            echo "ğŸš€ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰..."
            docker run -d -p 8080:8080 --name myapp --restart always \
              -e SPRING_PROFILES_ACTIVE=prod \
              -e DB_HOST='${{ secrets.DB_HOST }}' \
              -e DB_PORT='${{ secrets.DB_PORT }}' \
              -e DB_NAME='${{ secrets.DB_NAME }}' \
              -e DB_USERNAME='${{ secrets.DB_USERNAME }}' \
              -e DB_PASSWORD='${{ secrets.DB_PASSWORD }}' \
              -e S3_BUCKET='${{ secrets.S3_BUCKET }}' \
              -e S3_BASE_URL='${{ secrets.S3_BASE_URL }}' \
              -e S3_REGION='${{ secrets.S3_REGION }}' \
              myapp

            echo "âœ… ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ í™•ì¸:"
            docker ps -a
